name: Security Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    name: Scan for secrets
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: HEAD
          extra_args: --debug --only-verified
      
      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  file-check:
    runs-on: ubuntu-latest
    name: Check for sensitive files
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for sensitive file patterns
        run: |
          FOUND=0
          
          echo "Checking for sensitive files..."
          
          if find . -type f \( -name "*.pem" -o -name "*.key" -o -name "*_rsa" -o -name "*.p12" \) | grep -v ".git" | grep .; then
            echo "ERROR: Found private key files!"
            FOUND=1
          fi
          
          if find . -type f \( -name "*credentials*" -o -name "*password*" -o -name ".env" -o -name "*.secret" \) | grep -v ".git" | grep -v "README.md" | grep .; then
            echo "ERROR: Found credential files!"
            FOUND=1
          fi
          
          if find . -type f -path "*sops*" -o -path "*age*" | grep -v ".git" | grep -v ".gitleaks.toml" | grep .; then
            echo "ERROR: Found SOPS/age secret files!"
            FOUND=1
          fi
          
          if find . -type f \( -name "id_rsa" -o -name "id_dsa" -o -name "id_ecdsa" -o -name "id_ed25519" \) | grep -v ".git" | grep .; then
            echo "ERROR: Found SSH keys!"
            FOUND=1
          fi
          
          if [ $FOUND -eq 0 ]; then
            echo "PASS: No sensitive files found"
          else
            echo "FAIL: Sensitive files detected! Please remove them."
            exit 1
          fi
      
      - name: Check for hardcoded secrets in code
        run: |
          echo "Checking for hardcoded secrets..."
          
          if grep -r -i -E "(password|passwd|pwd|secret|token|api_key|apikey).*=.*['\"][^'\"]{8,}" . \
            --exclude-dir=.git \
            --exclude="*.md" \
            --exclude="security-check.yml" \
            --exclude=".gitleaks.toml"; then
            echo "ERROR: Found potential hardcoded secrets!"
            exit 1
          fi
          
          echo "PASS: No hardcoded secrets found"

  lint-config:
    runs-on: ubuntu-latest
    name: Validate configuration files
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for secrets in config files
        run: |
          if grep -r "SOPS_AGE_KEY_FILE\|api.*key\|password\|token" \
            shell/.zshrc \
            terminal/wezterm/.wezterm.lua \
            2>/dev/null; then
            echo "WARNING: Found potential secret references in config files"
            echo "Please ensure these are template examples, not real values"
          fi
      
      - name: Validate shell script syntax
        run: |
          if [ -f install.sh ]; then
            bash -n install.sh
            echo "PASS: install.sh syntax is valid"
          fi